# This will log the local Administrators group to a txt file and compare it to the last run.
# It will generate an RMM alert if changes are detected.
# Recommend to run daily.

# Author: Adam Matthews (https://unboundedtechnology.com)
# Inspired by the Syncro Staff community library script.

Import-Module $env:SyncroModule

$oldFile = "C:\temp\a-old.txt"
$newFile = "C:\temp\a-new.txt"

$obj_group = [ADSI]"WinNT://localhost/Administrators,group"
$members= @($obj_group.psbase.Invoke("Members")) | foreach{([ADSI]$_).InvokeGet("Name")}

$oldFilePresent = Test-Path -Path $oldFile
$newFilePresent = Test-Path -Path $newFile

#1. If both exist, delete old and move new to old
if($oldFilePresent -And $newFilePresent){
    del $oldFile
    mv $newFile $oldFile
}

#2. If old exists, write new and do comparison
if($oldFilePresent){
    "Current local administrators: $members" | Out-File -filepath $newFile 
    $comparison = compare-object (get-content $newFile) (get-content $oldFile)
    if($comparison){
        Rmm-Alert -Category "Local admins have changed! - Investigate why" -Body "Local Administrators group has changed!  `n - Previous local administrators: $(get-content $oldFile) `n -- Current local administrators: $(get-content $newFile)"
        Write-Host "Local Administrators group has changed! `n - Previous local administrators: $(get-content $oldFile) `n  - Current local administrators: $(get-content $newFile)"
    }else{
        Log-Activity -Message "Security - Local admin accounts monitoring - No changes detected." -EventName "Changes to Admins"
        Write-Host "Local Admin accounts - No changes detected."
    }
}

#3. If old dosn't exisit, write new, and move it to old to setup good state for next run
if(!$oldFilePresent){
    "Current local administrators: $members" | Out-File -filepath $newFile
    mv $newFile $oldFile
    Log-Activity -Message "Security - Local admin accounts monitoring - First run, initial log created" -EventName "Changes to Admins"
    Write-Host "Local Admin accounts - First run - Initial log created"
    }
