#Sets the PC to enter a locked state when an inactivity threshold is reached.

Import-Module $env:SyncroModule

# Idle Time Before Inactivity Lock (in minuites) 
$TimeOutMinutes = 10

# Allow Shorter Inactivity Lock period if it's already configured as such?
$AllowShorter = "YES"

# Calculations:
$TimeOutValue = ([int]$TimeOutMinutes * 60) # Calculate the number of idle seconds before screensaver activates from the minutes value.

# Determine if the TimeOutValue can be less than that specified.
$AllowShorter = $AllowShorter.ToUpper()
$possibleRunValues = "TRUE","YES","Y"
$leaveIfShorter = $false
If ($possibleRunValues -contains $AllowShorter) {
  $leaveIfShorter = $true
}

function Test-RegistryValue {
  param (
    [parameter(Mandatory=$true)]
    [ValidateNotNullOrEmpty()]$Path,
    [parameter(Mandatory=$true)]
    [ValidateNotNullOrEmpty()]$Value
  )

  try {
    Get-ItemProperty -Path $Path -Name $Value -ErrorAction Stop | Out-Null
    return $true
  }

  catch {
    return $false
  }
}

# Reset the screensaver timeout to $TimeOutValue if it is not set or set to a value larger than $TimeOutValue.
if ((Test-RegistryValue -Path "HKLM:Software\Microsoft\Windows\CurrentVersion\Policies\System" -Value 'InactivityTimeoutSecs') -And $leaveIfShorter) {
  [int]$Current_TimeOutValue = (Get-ItemProperty -Path "HKLM:Software\Microsoft\Windows\CurrentVersion\Policies\System" -Name "InactivityTimeoutSecs").InactivityTimeoutSecs
  if ($Current_TimeOutValue -eq 0 -OR $Current_TimeOutValue -gt $TimeOutValue) {
    Set-ItemProperty -Path "HKLM:Software\Microsoft\Windows\CurrentVersion\Policies\System" -Name "InactivityTimeoutSecs" -value $TimeOutValue | Out-Null
  }
}
else {New-ItemProperty -Path "HKLM:Software\Microsoft\Windows\CurrentVersion\Policies\System" -Name "InactivityTimeoutSecs" -Value $TimeOutValue -PropertyType DWORD -Force | Out-Null}

Write-Host "Idle-time lock settings updated/verified. $($TimeOutMinutes) minutes or less will be enforced after the next system reboot."
Log-Activity -Message "Idle-time inactivity lock settings. $($TimeOutMinutes) minutes or less verified and enforced." -EventName "Idle Time - Inactivity Lock"
